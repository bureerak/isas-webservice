<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Admin - Hotel Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="dashboard-v2.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="dashboard-v2">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <span class="material-symbols-outlined">hotel</span> <span>Hotel Admin</span>
        </div>
        <nav class="sidebar-nav">
            <a class="nav-item active" id="tabOverview" onclick="switchTab('overview')">
                <span class="material-symbols-outlined">monitoring</span> <span>Overview</span>
            </a>
            <a class="nav-item" id="tabRooms" onclick="switchTab('rooms')">
                <span class="material-symbols-outlined">bed</span> <span>Rooms</span>
            </a>
            <a class="nav-item" id="tabBookings" onclick="switchTab('bookings')">
                <span class="material-symbols-outlined">content_paste_search</span> <span>Bookings</span>
            </a>
            <a class="nav-item" id="tabGuests" onclick="switchTab('guests')">
                <span class="material-symbols-outlined">group</span> <span>Guests</span>
            </a>
            <div
                style="margin-top: 2rem; padding: 0.5rem 1rem; font-size: 0.75rem; color: rgba(255,255,255,0.4); text-transform: uppercase;">
                Settings
            </div>
            <a class="nav-item" href="reception.html">
                <span class="material-symbols-outlined">bolt</span> <span>Reception View</span>
            </a>
            <a class="nav-item" href="index.html">
                <span class="material-symbols-outlined">home</span> <span>Landing Page</span>
            </a>
        </nav>
        <div style="padding: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
            <a class="nav-item" onclick="logout()" style="margin-bottom: 0;">
                <span class="material-symbols-outlined">logout</span> <span>Sign Out</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="main-wrapper">
        <header class="top-bar">
            <div style="font-weight: 600; font-size: 1.125rem;" id="pageTitle">Overview</div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div id="staffBadge"
                    style="font-size: 0.875rem; color: var(--text-muted); background: #f1f5f9; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 500;">
                    Loading...
                </div>
            </div>
        </header>

        <main class="page-content">
            <div id="alertContainer"></div>

            <!-- OVERVIEW TAB -->
            <div id="panelOverview">
                <div class="stat-grid">
                    <div class="stat-card-v2">
                        <div class="stat-header">
                            <span class="stat-title">OCCUPANCY RATE</span>
                            <span class="material-symbols-outlined" style="color: var(--primary);">bed</span>
                        </div>
                        <div class="stat-value" id="statOccupied">-</div>
                    </div>
                    <div class="stat-card-v2">
                        <div class="stat-header">
                            <span class="stat-title">TODAY ARRIVALS</span>
                            <span class="material-symbols-outlined" style="color: var(--success);">login</span>
                        </div>
                        <div class="stat-value" id="statArrivals">-</div>
                    </div>
                    <div class="stat-card-v2">
                        <div class="stat-header">
                            <span class="stat-title">MONTHLY REVENUE</span>
                            <span class="material-symbols-outlined" style="color: var(--warning);">payments</span>
                        </div>
                        <div class="stat-value" id="statRevenue">-</div>
                    </div>
                </div>

                <div class="grid grid-2">
                    <div class="card-v2">
                        <h2 class="card-title-v2"><span class="material-symbols-outlined">trending_up</span> Revenue
                            Overview</h2>
                        <canvas id="revenueChart" height="200"></canvas>
                    </div>
                    <div class="card-v2">
                        <h2 class="card-title-v2"><span class="material-symbols-outlined">description</span> Monthly
                            Summary</h2>
                        <div class="table-v2-container">
                            <table class="table-v2">
                                <thead>
                                    <tr>
                                        <th>Month</th>
                                        <th>Bookings</th>
                                        <th>Revenue</th>
                                    </tr>
                                </thead>
                                <tbody id="revenueTableBody">
                                    <tr>
                                        <td colspan="3" style="text-align:center;">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ROOMS TAB -->
            <div id="panelRooms" style="display:none;">
                <div class="grid grid-2">
                    <div class="card-v2">
                        <h2 class="card-title-v2"><span class="material-symbols-outlined">add_circle</span> Add New Room
                        </h2>
                        <form id="addRoomForm">
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="color: var(--text-main); font-size: 0.875rem;">Room Number</label>
                                <input type="text" id="roomNumber" class="form-control"
                                    style="background: white; border: 1px solid var(--border);" required>
                            </div>
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="color: var(--text-main); font-size: 0.875rem;">Room Type</label>
                                <select id="roomTypeId" class="form-control"
                                    style="background: white; border: 1px solid var(--border);" required>
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Add Room</button>
                        </form>
                    </div>
                    <div class="card-v2">
                        <h2 class="card-title-v2"><span class="material-symbols-outlined">delete</span> Quick Delete
                        </h2>
                        <form id="deleteRoomForm">
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="color: var(--text-main); font-size: 0.875rem;">Room ID</label>
                                <input type="number" id="deleteRoomId" class="form-control"
                                    style="background: white; border: 1px solid var(--border);" required>
                            </div>
                            <button type="submit" class="btn btn-danger" style="width: 100%;">Delete Room</button>
                        </form>
                    </div>
                </div>

                <div class="card-v2" style="margin-top: 1.5rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 class="card-title-v2" style="margin: 0;"><span class="material-symbols-outlined">bed</span>
                            All Rooms</h2>
                        <button class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;"
                            onclick="loadAllRooms()">Refresh</button>
                    </div>
                    <div class="table-v2-container">
                        <table class="table-v2">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th># Number</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Price</th>
                                    <th>Capacity</th>
                                </tr>
                            </thead>
                            <tbody id="roomsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align:center;">Click refresh to load...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- BOOKINGS TAB -->
            <div id="panelBookings" style="display:none;">
                <div class="card-v2">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 class="card-title-v2" style="margin: 0;"><span
                                class="material-symbols-outlined">receipt_long</span> Master Booking List</h2>
                        <button class="btn btn-secondary" onclick="loadAllBookings()">Refresh</button>
                    </div>
                    <div class="table-v2-container">
                        <table class="table-v2">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Guest</th>
                                    <th>Room</th>
                                    <th>Stay Period</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="bookingsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align:center;">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- GUESTS TAB -->
            <div id="panelGuests" style="display:none;">
                <div class="card-v2">
                    <div
                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; flex-wrap:wrap; gap:1rem;">
                        <h2 class="card-title-v2" style="margin: 0;"><span
                                class="material-symbols-outlined">group</span> Guest Directory</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <input class="form-control" id="guestSearch" placeholder="Search guests..."
                                oninput="filterAdminGuests()"
                                style="max-width:280px; background:white; border: 1px solid var(--border);">
                            <button class="btn btn-secondary" style="padding: 0.5rem 1rem;"
                                onclick="loadAdminGuests()">Refresh</button>
                        </div>
                    </div>
                    <div class="table-v2-container">
                        <table class="table-v2">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Details</th>
                                    <th>Contact</th>
                                    <th>Identity</th>
                                    <th>History</th>
                                </tr>
                            </thead>
                            <tbody id="guestsTableBody">
                                <tr>
                                    <td colspan="5" style="text-align:center;">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="app.js"></script>
    <script>
        // Auth guard (Manager only)
        const token = localStorage.getItem('hotel_token');
        const role = localStorage.getItem('hotel_role');
        const staffName = localStorage.getItem('hotel_name');
        if (!token) { window.location.href = 'login.html'; }
        if (role !== 'manager') { window.location.href = 'reception.html'; }
        document.getElementById('staffBadge').textContent = `üë§ ${staffName}`;

        function logout() {
            localStorage.removeItem('hotel_token');
            localStorage.removeItem('hotel_role');
            localStorage.removeItem('hotel_name');
            window.location.href = 'login.html';
        }

        let revenueChart = null;

        function switchTab(tab) {
            const tabs = ['overview', 'rooms', 'bookings', 'guests'];
            tabs.forEach(t => {
                const btn = document.getElementById(`tab${t.charAt(0).toUpperCase() + t.slice(1)}`);
                const panel = document.getElementById(`panel${t.charAt(0).toUpperCase() + t.slice(1)}`);
                if (btn) btn.classList.toggle('active', t === tab);
                if (panel) panel.style.display = t === tab ? '' : 'none';
            });

            const titleMap = {
                'overview': 'Overview Dashboard',
                'rooms': 'Room Management',
                'bookings': 'Booking History',
                'guests': 'Guest Directory'
            };
            document.getElementById('pageTitle').textContent = titleMap[tab];

            // Trigger data load
            if (tab === 'overview') loadOverview();
            if (tab === 'rooms') loadAllRooms();
            if (tab === 'bookings') loadAllBookings();
            if (tab === 'guests') loadAdminGuests();
        }

        async function loadOverview() {
            try {
                const res = await authFetch('/api/reports/summary');
                const data = await res.json();
                if (!res.ok) return;

                const occ = data.occupancy_today;
                const occRate = occ.total_rooms > 0 ? Math.round((occ.occupied_rooms / occ.total_rooms) * 100) : 0;
                document.getElementById('statOccupied').textContent = `${occRate}% (${occ.occupied_rooms}/${occ.total_rooms})`;
                document.getElementById('statArrivals').textContent = data.today_arrivals.length;

                const thisMonth = data.revenue_by_month[0];
                document.getElementById('statRevenue').textContent =
                    thisMonth ? `‡∏ø${Number(thisMonth.total_revenue).toLocaleString()}` : '‡∏ø0';

                // Table
                const tbody = document.getElementById('revenueTableBody');
                tbody.innerHTML = data.revenue_by_month.map(r => `
                    <tr>
                        <td><strong>${r.month}</strong></td>
                        <td>${r.total_bookings}</td>
                        <td>‡∏ø${Number(r.total_revenue).toLocaleString()}</td>
                    </tr>`).join('') || '<tr><td colspan="3" style="text-align:center;">No data</td></tr>';

                // Chart
                renderRevenueChart(data.revenue_by_month);
            } catch (e) { console.error(e); }
        }

        function renderRevenueChart(revenueData) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            const sortedData = [...revenueData].reverse();

            if (revenueChart) revenueChart.destroy();

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedData.map(d => d.month),
                    datasets: [{
                        label: 'Revenue (‡∏ø)',
                        data: sortedData.map(d => d.total_revenue),
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointBackgroundColor: '#2563eb'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        let adminAllGuests = [];
        async function loadAdminGuests() {
            const res = await authFetch('/api/guests');
            adminAllGuests = await res.json();
            renderAdminGuests(adminAllGuests);
        }

        function filterAdminGuests() {
            const q = document.getElementById('guestSearch').value.toLowerCase();
            renderAdminGuests(adminAllGuests.filter(g =>
                g.full_name.toLowerCase().includes(q) || (g.id_card || '').toLowerCase().includes(q) || (g.email || '').toLowerCase().includes(q)
            ));
        }

        function renderAdminGuests(guests) {
            const tbody = document.getElementById('guestsTableBody');
            if (!guests.length) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No guests found</td></tr>'; return; }
            tbody.innerHTML = guests.map(g => `<tr>
                <td><span style="color:var(--text-muted); font-weight:600;">#${g.id}</span></td>
                <td>
                    <div style="font-weight:700; color:var(--text-main);">${g.full_name}</div>
                    <div style="font-size:0.75rem; color: #f59e0b;">${g.notes ? `‚ö†Ô∏è ${g.notes}` : ''}</div>
                </td>
                <td>
                    <div style="font-size:0.875rem;">üìû ${g.phone || '-'}</div>
                    <div style="font-size:0.75rem; color:var(--text-muted);">üìß ${g.email || '-'}</div>
                </td>
                <td>
                    <div style="font-size:0.875rem;">üÜî ${g.id_card || '-'}</div>
                    <div style="font-size:0.75rem; color:var(--text-muted);">üè≥Ô∏è ${g.nationality || '-'}</div>
                </td>
                <td>
                    <div style="font-size:0.875rem;">Stays: <strong>${g.total_bookings}</strong></div>
                    <div style="font-size:0.75rem; color:var(--text-muted);">Last: ${g.last_stay ? formatDate(g.last_stay) : 'Never'}</div>
                </td>
            </tr>`).join('');
        }

        // Initialize
        loadOverview();
    </script>
</body>

</html>