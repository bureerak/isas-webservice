<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reception Desk - Hotel Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="dashboard-v2.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
</head>

<body class="dashboard-v2">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <span class="material-symbols-outlined">hotel</span> <span>Reception Desk</span>
        </div>
        <nav class="sidebar-nav">
            <a class="nav-item active" id="tabArrivals" onclick="switchTab('arrivals')">
                <span class="material-symbols-outlined">login</span> <span>Today Arrivals</span>
            </a>
            <a class="nav-item" id="tabDepartures" onclick="switchTab('departures')">
                <span class="material-symbols-outlined">logout</span> <span>Departures</span>
            </a>
            <a class="nav-item" id="tabGuests" onclick="switchTab('guests')">
                <span class="material-symbols-outlined">group</span> <span>Guest Directory</span>
            </a>
            <div
                style="margin-top: 2rem; padding: 0.5rem 1rem; font-size: 0.75rem; color: rgba(255,255,255,0.4); text-transform: uppercase;">
                Navigation
            </div>
            <a class="nav-item" href="index.html">
                <span class="material-symbols-outlined">home</span> <span>Home Page</span>
            </a>
        </nav>
        <div style="padding: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
            <a class="nav-item" onclick="logout()" style="margin-bottom: 0;">
                <span class="material-symbols-outlined">logout</span> <span>Sign Out</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="main-wrapper">
        <header class="top-bar">
            <div style="display: flex; flex-direction: column;">
                <div style="font-weight: 600; font-size: 1.125rem;" id="pageTitle">Today's Arrivals</div>
                <div id="currentDate" style="font-size: 0.75rem; color: var(--text-muted);"></div>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div id="staffBadge"
                    style="font-size: 0.875rem; color: var(--text-muted); background: #f1f5f9; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 500;">
                    Loading...
                </div>
            </div>
        </header>

        <main class="page-content">
            <div id="alertContainer"></div>

            <!-- Stats Bar -->
            <div class="stat-grid">
                <div class="stat-card-v2">
                    <div class="stat-header">
                        <span class="stat-title">PENDING ARRIVALS</span>
                        <span class="material-symbols-outlined" style="color: var(--success);">login</span>
                    </div>
                    <div class="stat-value" id="statArrivals">-</div>
                </div>
                <div class="stat-card-v2">
                    <div class="stat-header">
                        <span class="stat-title">PENDING DEPARTURES</span>
                        <span class="material-symbols-outlined" style="color: var(--danger);">logout</span>
                    </div>
                    <div class="stat-value" id="statDepartures">-</div>
                </div>
                <div class="stat-card-v2">
                    <div class="stat-header">
                        <span class="stat-title">CURRENT OCCUPANCY</span>
                        <span class="material-symbols-outlined" style="color: var(--primary);">bed</span>
                    </div>
                    <div class="stat-value" id="statOccupied">-</div>
                </div>
            </div>

            <!-- Panels -->
            <div id="panelArrivals" class="card-v2">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 class="card-title-v2" style="margin: 0;"><span class="material-symbols-outlined">login</span>
                        Check-in Required Today</h2>
                    <button class="btn btn-secondary" onclick="loadDashboard()">Refresh List</button>
                </div>
                <div class="table-v2-container">
                    <table class="table-v2">
                        <thead>
                            <tr>
                                <th>Booking ID</th>
                                <th>Guest Details</th>
                                <th>Room Info</th>
                                <th>Billing</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="arrivalsList">
                            <tr>
                                <td colspan="5" style="text-align:center;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="panelDepartures" class="card-v2" style="display:none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 class="card-title-v2" style="margin: 0;"><span class="material-symbols-outlined">logout</span>
                        Check-out Required Today</h2>
                    <button class="btn btn-secondary" onclick="loadDashboard()">Refresh List</button>
                </div>
                <div class="table-v2-container">
                    <table class="table-v2">
                        <thead>
                            <tr>
                                <th>Booking ID</th>
                                <th>Guest Details</th>
                                <th>Room Info</th>
                                <th>Billing</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="departuresList">
                            <tr>
                                <td colspan="5" style="text-align:center;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="panelGuests" class="card-v2" style="display:none;">
                <div
                    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem; flex-wrap:wrap; gap:1rem;">
                    <h2 class="card-title-v2" style="margin: 0;"><span class="material-symbols-outlined">group</span>
                        Master Guest Directory</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <input class="form-control" id="guestSearch" placeholder="Search guests..."
                            oninput="filterGuests()"
                            style="max-width:300px; background:white; border: 1px solid var(--border);">
                        <button class="btn btn-secondary" onclick="loadGuests()">Refresh</button>
                    </div>
                </div>
                <div class="table-v2-container">
                    <table class="table-v2">
                        <thead>
                            <tr>
                                <th>Guest Profile</th>
                                <th>Contact Info</th>
                                <th>Identification</th>
                                <th>Activity</th>
                            </tr>
                        </thead>
                        <tbody id="guestsList">
                            <tr>
                                <td colspan="4" style="text-align:center;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="app.js"></script>
    <script>
        // Auth guard
        const token = localStorage.getItem('hotel_token');
        const role = localStorage.getItem('hotel_role');
        const name = localStorage.getItem('hotel_name');
        if (!token) { window.location.href = 'login.html'; }

        document.getElementById('staffBadge').textContent = `üë§ ${name || 'Staff'}`;
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        function logout() {
            localStorage.removeItem('hotel_token');
            localStorage.removeItem('hotel_role');
            localStorage.removeItem('hotel_name');
            window.location.href = 'login.html';
        }

        let allGuests = [];

        function switchTab(tab) {
            const tabs = ['arrivals', 'departures', 'guests'];
            tabs.forEach(t => {
                const btn = document.getElementById(`tab${t.charAt(0).toUpperCase() + t.slice(1)}`);
                const panel = document.getElementById(`panel${t.charAt(0).toUpperCase() + t.slice(1)}`);
                if (btn) btn.classList.toggle('active', t === tab);
                if (panel) panel.style.display = t === tab ? '' : 'none';
            });

            const titleMap = {
                'arrivals': "Today's Arrivals",
                'departures': "Today's Departures",
                'guests': "Guest Directory"
            };
            document.getElementById('pageTitle').textContent = titleMap[tab];

            if (tab === 'guests' && !allGuests.length) loadGuests();
        }

        async function loadDashboard() {
            try {
                const res = await authFetch('/api/reports/summary');
                const data = await res.json();
                if (!res.ok) { showAlert('Failed to load dashboard', 'error'); return; }

                document.getElementById('statArrivals').textContent = data.today_arrivals.length;
                document.getElementById('statDepartures').textContent = data.today_departures.length;

                const occ = data.occupancy_today;
                const occRate = occ.total_rooms > 0 ? Math.round((occ.occupied_rooms / occ.total_rooms) * 100) : 0;
                document.getElementById('statOccupied').textContent = `${occRate}% (${occ.occupied_rooms}/${occ.total_rooms})`;

                renderArrivals(data.today_arrivals);
                renderDepartures(data.today_departures);
            } catch (err) {
                showAlert('Error loading dashboard', 'error');
            }
        }

        function renderArrivals(arrivals) {
            const el = document.getElementById('arrivalsList');
            if (!arrivals.length) { el.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:2rem; color:var(--text-muted);">No arrivals scheduled for today</td></tr>'; return; }

            el.innerHTML = arrivals.map(b => `<tr>
                <td><span style="font-weight:600; color:var(--text-muted);">#${b.id}</span></td>
                <td><div style="font-weight:700; color:var(--text-main);">${b.guest_name}</div></td>
                <td>
                    <div style="font-weight:600;">Room ${b.room_number}</div>
                    <div style="font-size:0.75rem; color:var(--text-muted);">${b.room_type}</div>
                </td>
                <td><div style="font-weight:700; color:var(--primary);">‡∏ø${Number(b.total_price).toLocaleString()}</div></td>
                <td><button class="btn btn-success" style="padding:0.5rem 1rem; font-size:0.875rem; display:flex; align-items:center; gap:0.5rem;" onclick="checkIn(${b.id})">
                    Check-in <span class="material-symbols-outlined" style="font-size:18px;">check_circle</span>
                </button></td>
            </tr>`).join('');
        }

        function renderDepartures(departures) {
            const el = document.getElementById('departuresList');
            if (!departures.length) { el.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:2rem; color:var(--text-muted);">No departures scheduled for today</td></tr>'; return; }

            el.innerHTML = departures.map(b => `<tr>
                <td><span style="font-weight:600; color:var(--text-muted);">#${b.id}</span></td>
                <td><div style="font-weight:700; color:var(--text-main);">${b.guest_name}</div></td>
                <td>
                    <div style="font-weight:600;">Room ${b.room_number}</div>
                    <div style="font-size:0.75rem; color:var(--text-muted);">${b.room_type}</div>
                </td>
                <td><div style="font-weight:700; color:var(--primary);">‡∏ø${Number(b.total_price).toLocaleString()}</div></td>
                <td><button class="btn btn-primary" style="padding:0.5rem 1rem; font-size:0.875rem; display:flex; align-items:center; gap:0.5rem;" onclick="checkOut(${b.id})">
                    Check-out <span class="material-symbols-outlined" style="font-size:18px;">done_all</span>
                </button></td>
            </tr>`).join('');
        }

        async function checkIn(bookingId) {
            if (!confirm(`Check-in Booking #${bookingId}?`)) return;
            const res = await authFetch(`/api/bookings/${bookingId}/check-in`, { method: 'PATCH' });
            if (res.ok) { showAlert(`Guest checked in successfully!`, 'success'); loadDashboard(); }
            else { const data = await res.json(); showAlert(data.error, 'error'); }
        }

        async function checkOut(bookingId) {
            if (!confirm(`Check-out Booking #${bookingId}?`)) return;
            const res = await authFetch(`/api/bookings/${bookingId}/check-out`, { method: 'PATCH' });
            if (res.ok) { showAlert(`Guest checked out successfully!`, 'success'); loadDashboard(); }
            else { const data = await res.json(); showAlert(data.error, 'error'); }
        }

        async function loadGuests() {
            const res = await authFetch('/api/guests');
            allGuests = await res.json();
            renderGuests(allGuests);
        }

        function filterGuests() {
            const q = document.getElementById('guestSearch').value.toLowerCase();
            renderGuests(allGuests.filter(g =>
                g.full_name.toLowerCase().includes(q) || (g.id_card || '').toLowerCase().includes(q)
            ));
        }

        function renderGuests(guests) {
            const el = document.getElementById('guestsList');
            if (!guests.length) { el.innerHTML = '<tr><td colspan="4" style="text-align:center;">No guests found</td></tr>'; return; }

            el.innerHTML = guests.map(g => `<tr>
                <td>
                    <div style="font-weight:700; color:var(--text-main);">${g.full_name}</div>
                    <div style="font-size:0.75rem; color:#f59e0b;">${g.notes ? `‚ö†Ô∏è ${g.notes}` : ''}</div>
                </td>
                <td>
                    <div style="font-size:0.875rem;">üìû ${g.phone || '-'}</div>
                    <div style="font-size:0.75rem; color:var(--text-muted);">üìß ${g.email || '-'}</div>
                </td>
                <td>
                    <div style="font-size:0.875rem;">üÜî ${g.id_card || '-'}</div>
                    <div style="font-size:0.75rem; color:var(--text-muted);">üè≥Ô∏è ${g.nationality || '-'}</div>
                </td>
                <td>
                    <div style="font-size:0.875rem;">Total Stays: <strong>${g.total_bookings}</strong></div>
                    <div style="font-size:0.75rem; color:var(--text-muted);">Last: ${g.last_stay ? formatDate(g.last_stay) : 'Never'}</div>
                </td>
            </tr>`).join('');
        }

        loadDashboard();
    </script>
</body>

</html>